{"version":3,"file":"bundle.js","sources":["../src/utils/index.ts","../src/reactivity/effect.ts","../src/reactivity/baseHandler.ts","../src/reactivity/reactive.ts"],"sourcesContent":["export function isObject(obj): boolean {\r\n  return typeof obj === 'object' && obj != null\r\n}\r\n\r\nconst hasOwnProperty = Object.prototype.hasOwnProperty\r\n\r\nexport function hasOwn(target, key): boolean {\r\n  return hasOwnProperty.call(target, key)\r\n}\r\n\r\nexport function isArray(arr): boolean {\r\n  return Array.isArray(arr)\r\n}\r\n\r\nexport function hasChange(v1, v2): boolean {\r\n  return v1 !== v2\r\n}\r\n","import {isArray} from \"../utils\";\r\n\r\nconst effectStack: Function[] = []\r\nlet currentEffect: Function | null = null\r\n\r\nfunction createReactiveEffect(fun) {\r\n  const effect = function () {\r\n    if (!effectStack.includes(effect)) {\r\n      try {\r\n        effectStack.push(effect)\r\n        currentEffect = effect\r\n        return fun()\r\n      } finally {\r\n        effectStack.pop()\r\n        currentEffect = effectStack[effectStack.length - 1]\r\n      }\r\n    }\r\n  }\r\n  return effect\r\n}\r\n\r\nfunction effect(fun, opts = {}) {\r\n  const effect = createReactiveEffect(fun)\r\n  effect()\r\n}\r\n\r\n// 建立 属性和effect之间的关联（对应Vue2中的dep和watcher）\r\nconst targetMap = new WeakMap\r\n\r\nfunction track(target, key) {\r\n  if (currentEffect == undefined) return\r\n  let depsMap = targetMap.get(target)\r\n  if (!depsMap) {\r\n    targetMap.set(target, (depsMap = new Map()))\r\n  }\r\n  let dep = depsMap.get(key)\r\n  if (!dep) {\r\n    depsMap.set(key, (dep = new Set()))\r\n  }\r\n  if (!dep.has(currentEffect)) {\r\n    dep.add(currentEffect)\r\n  }\r\n}\r\n\r\nconst run = effects => {\r\n  if (effects) effects.forEach(effect => effect())\r\n}\r\n\r\nfunction trigger(target, type, key, value) {\r\n  const depsMap = targetMap.get(target)\r\n  if (!depsMap) return\r\n\r\n\r\n  if (key === 'length' && isArray(target)) {\r\n    depsMap.forEach((dep, k) => {\r\n      // 如果改变了数组长度，触发更新\r\n      if (k === 'length' || k >= value) run(dep)\r\n    })\r\n    return\r\n  }\r\n\r\n  // 修改\r\n  if (key != undefined) {\r\n    const effects = depsMap.get(key)\r\n    run(effects)\r\n  }\r\n\r\n  // 添加\r\n  switch (type) {\r\n    case 'add':\r\n      if (isArray(target)) {\r\n        if (parseInt(key) + '' === key) {\r\n          run(depsMap.get('length'))\r\n        }\r\n      }\r\n      break\r\n    default:\r\n      break\r\n  }\r\n}\r\n\r\nexport {\r\n  effect,\r\n  effectStack,\r\n  currentEffect,\r\n  track,\r\n  trigger\r\n}\r\n","import {currentEffect, effectStack, track, trigger} from \"./effect\";\r\nimport {hasChange, hasOwn, isArray, isObject} from \"../utils\";\r\nimport {reactive} from \"./reactive\";\r\n\r\nconst mutableHandlers = {\r\n  get(target, key, recevier) {\r\n    const res = Reflect.get(target, key, recevier)\r\n\r\n    if (typeof key === 'symbol') return res\r\n    // 依赖收集\r\n    track(target, key)\r\n\r\n    // 取值如果是对象，递归代理（懒代理）\r\n    return isObject(res) ? reactive(res) : res\r\n  },\r\n  set(target, key, value, recevier) {\r\n    const oldVal = target[key]\r\n\r\n    // 判断是否新增属性\r\n    const hadKey = isArray(target) && (parseInt(key, 10) + '' === key) ? Number(key) < target.length : hasOwn(target, key)\r\n\r\n    const res = Reflect.set(target, key, value, recevier)\r\n\r\n    if (!hadKey) {\r\n      // 新增属性\r\n      trigger(target, 'add', key, value)\r\n    } else if (hasChange(oldVal, value)) {\r\n      // 修改属性\r\n      trigger(target, 'set', key, value)\r\n    }\r\n\r\n    return res\r\n  }\r\n}\r\n\r\nexport {\r\n  mutableHandlers\r\n}\r\n","import {isObject} from \"../utils\";\r\nimport {mutableHandlers} from \"./baseHandler\";\r\n\r\nconst reactiveMap = new WeakMap()\r\n\r\nfunction createReactiveObject(target, baseHandler) {\r\n  if (!isObject(target)) return target\r\n  if (!reactiveMap.has(target)) {\r\n    const proxy = new Proxy(target, baseHandler)\r\n    reactiveMap.set(target, proxy)\r\n    return proxy\r\n  }\r\n  return reactiveMap.get(target)\r\n}\r\n\r\nfunction reactive(target) {\r\n  return createReactiveObject(target, mutableHandlers)\r\n}\r\n\r\nexport {\r\n  reactive\r\n}\r\n"],"names":[],"mappings":"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"}